name: Sync API Hooks to Frontend

on:
  push:
    branches:
      - main  # main ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ
    paths:
      - '**.bru'  # .bru íŒŒì¼ ë³€ê²½ ì‹œë§Œ
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  generate-and-sync:
    runs-on: ubuntu-latest

    steps:
      # 1. GitHub App í† í° ìƒì„±
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: Precision-Traffic  # âš ï¸ ì—¬ê¸°ë¥¼ ë³¸ì¸ GitHub ì‚¬ìš©ìžëª…ìœ¼ë¡œ ë³€ê²½
          repositories: "api-bruno,BUS-LIVE-WEB"

      # 2. Bruno ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Bruno Repo
        uses: actions/checkout@v4
        with:
          path: bruno-repo

      # 3. í”„ë¡ íŠ¸ì—”ë“œ ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Frontend Repo
        uses: actions/checkout@v4
        with:
          repository: Precision-Traffic/BUS-LIVE-WEB
          token: ${{ steps.generate-token.outputs.token }}
          path: frontend-repo

      # 4. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 5. bruno-api-typescript ì„¤ì¹˜
      - name: Install bruno-api-typescript
        run: |
          cd frontend-repo
          npm install -D github:manNomi/bruno-api-typescript
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}

      # 6. React Query í›… ìƒì„±
      - name: Generate React Query Hooks
        run: |
          cd frontend-repo
          npx bruno-api generate-hooks \
            -i ../bruno-repo/bruno \
            -o ./src/apis \
            --axios-path "@/utils/axiosInstance"

      # 7. ë³€ê²½ì‚¬í•­ í™•ì¸
      - name: Check for changes
        id: git-check
        run: |
          cd frontend-repo
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes"
          fi

      # 8. ë¸Œëžœì¹˜ ìƒì„± ë° ì»¤ë°‹
      - name: Commit and Push Changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          cd frontend-repo

          # Git ì„¤ì •
          git config user.name "bruno-api-sync-bot[bot]"
          git config user.email "bruno-api-sync-bot[bot]@users.noreply.github.com"

          # ë¸Œëžœì¹˜ ìƒì„±
          BRANCH_NAME="auto/update-api-hooks-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME

          # ì»¤ë°‹
          git add src/apis
          git commit -m "chore: update API hooks from Bruno

          ðŸ¤– Auto-generated by bruno-api-typescript

          Source: ${{ github.repository }}@${{ github.sha }}
          Triggered by: ${{ github.actor }}"

          # í‘¸ì‹œ
          git push origin $BRANCH_NAME

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: commit

      # 9. PR ìƒì„±
      - name: Create Pull Request
        if: steps.git-check.outputs.has_changes == 'true'
        working-directory: frontend-repo
        run: |
          gh pr create \
            --title "ðŸ”„ Update API Hooks from Bruno" \
            --body "## ðŸ¤– Auto-generated PR

          React Query í›…ì´ Bruno API ë³€ê²½ì‚¬í•­ì„ ë°˜ì˜í•˜ì—¬ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.

          ### ðŸ“‹ Source Information
          - **Repository**: \`${{ github.repository }}\`
          - **Commit**: [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **Triggered by**: @${{ github.actor }}

          ### ðŸ“¦ Generated Files
          - \`src/apis/**/*.ts\` - React Query hooks
          - \`src/apis/queryKeys.ts\` - Query key constants

          ### âœ… Review Checklist
          - [ ] Breaking changes í™•ì¸
          - [ ] ë³€ê²½ëœ API ì‚¬ìš©í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸
          - [ ] \`npm run type-check\` ì‹¤í–‰
          - [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (\`npm test\`)

          ---
          *Generated by [bruno-api-typescript](https://github.com/manNomi/bruno-api-typescript)*
          " \
            --base main \
            --head ${{ steps.commit.outputs.branch_name }} \
            --label "auto-generated" \
            --label "api-update"
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

      # 10. ê²°ê³¼ ìš”ì•½
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Workflow Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.git-check.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… PR created successfully!" >> $GITHUB_STEP_SUMMARY
            echo "- Branch: \`${{ steps.commit.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes detected. PR not created." >> $GITHUB_STEP_SUMMARY
          fi
